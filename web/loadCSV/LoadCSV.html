<html>
   <head>
     <meta charset="utf-8" />
      <title>Device Simulator</title>
	  <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.js" type="text/javascript">
		  
	 </script>
	 <script src="credentials.js" type="text/javascript"></script>
	 <script type = "text/javascript" language = "javascript">
var mqtt;
var mqtt_cansend = false;
var reconnectTimeout = 2000;
var host="liveobjects.orange-business.com"; //change this
var port=80;
var client_id=myCredentials.liveobjects.client_id

function onMessageArrived(msg){
    out_msg="Message received "+msg.payloadString+"<br>";
    out_msg=out_msg+"Message received Topic "+msg.destinationName;
    console.log(out_msg);

}
function onConnectionLost(){
    console.log("connection lost");
    mqtt_cansend = false;
}

function MQTTconnect(_onConnect, _onFailure) {
    console.log("connecting to "+ host +" "+ port);
    mqtt = new Paho.MQTT.Client(host,port,client_id);
    //document.write("connecting to "+ host);
    //mqtt.tls_set('c:/python34/steve/mqtt-demos/certs/ca.crt')
    var options = {
        useSSL:false,
        timeout: 3,
        userName:"json+device",
        password:myCredentials.liveobjects.password,
        onSuccess: _onConnect,
        onFailure: _onFailure

     };
    mqtt.onConnectionLost = onConnectionLost;
    mqtt.onMessageArrived = onMessageArrived
    mqtt.connect(options); //connect
    mqtt_cansend = true;
}

function MQTTpublish(txtPayload) {

    console.log("Sending Payload "+txtPayload)

    message = new Paho.MQTT.Message(txtPayload);
    message.destinationName = "dev/data";
    message.qos = 1;
    mqtt.send(message);

}


	  </script>
   </head>
     <body>
   <h1>Load CSV</h1>
   <div id="root"></div>
 	<script>
function inputCSVFile(app, onValidFileLoaded) {

	let container = document.createElement('div')
	container.setAttribute('class', 'w3-container')
	container.setAttribute('id', 'CSVFileSelector')
	
	let para = document.createElement('p')
	para.textContent = "Select local CSV File:"
	container.appendChild(para)
	
	let fileInput = document.createElement("input")
	fileInput.setAttribute('id', 'csv_file_input')
	fileInput.setAttribute('type', 'file')
	
	container.appendChild(fileInput)
	
    readFile = function () {
        var reader = new FileReader();
        reader.onload = function (readerEvent) {
			var content = readerEvent.target.result; // this is the content!
			console.log( content );
			
			//console.log(listOfLines)
			onValidFileLoaded(content)
        };
        // start reading the file. When it is done, calls the onload event defined above.
        //reader.readAsBinaryString(fileInput.files[0]);
		reader.readAsText(fileInput.files[0],'UTF-8');
    };

	fileInput.addEventListener('change', readFile);
	app.appendChild(container)
}	



function csv2Stream (csv_records, stream_consumer) {
    // first line is column's titles
	let fields = csv_records.split('\n')[0].replace(/\r/g, '').replace(/\"/g, '').split(';')
    //stream_consumer.init(fields)
    console.log(fields)
	let lines = csv_records.replace(/\r/g, '').replace(/\"/g, '').split('\n').slice(1, 20).map(elem => elem.split(';'))
    //console.log(lines)
    function sendNwait (li) {
            let jsLine = {}
            for (fi of fields) {
                jsLine[fi]=li[fields.indexOf(fi)]
            }
            stream_consumer(jsLine)
            setTimeout(end_emission, 1000)
        }
    function end_emission(){
    }
    Array.from(lines.slice(1)).forEach( (li) => sendNwait (li))
}
function csvtime2lotime(csvtime) {
// Change time from "2018-06-21 09:55:47" to "2018-06-21T09:55:47Z"
    return csvtime.substring(0,10) + 'T' + csvtime.substring(11,11+8) + 'Z'

}

function publishLine(event_data){
    console.log(event_data)
    let lo_data={
        "s":"urn:lo:nsid:flexy205:0475410668!uplink",
        "m":"MyModel",
        "v":{
            "variable":event_data.VarName,
            "v": (event_data.VarValue == "0" )? 0:1,
            "timestamp":csvtime2lotime(event_data.TimeString),}
        }
       console.log(lo_data)
    MQTTpublish(JSON.stringify(lo_data));
}

inputCSVFile(document.getElementById('root'), onValidFileLoaded = (fileContent) => {
    
	MQTTconnect(onConnect= () => {
        console.log("Connected ");
        mqtt.subscribe("dev/cmd");
        
        csv2Stream (fileContent, stream_consumer = publishLine);
        
        
    } , onFailure = () => {    
        console.log("Connection Attempt to Host "+host+"Failed");
        setTimeout(MQTTconnect, reconnectTimeout);
    });
})        

    
	</script>
   </body>
</html>
